# SSE ä¼˜åŒ–å­˜å‚¨æœºåˆ¶å®ç°æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå¯¹SSEçš„å­˜å‚¨æœºåˆ¶è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **å‡å°‘æ•°æ®åº“å†™å…¥é¢‘ç‡**ï¼šåŸæ¥æ¯ä¸ªupdateäº‹ä»¶éƒ½ç«‹å³å†™å…¥æ•°æ®åº“ï¼Œç°åœ¨æ”¹ä¸ºæ‰¹é‡å­˜å‚¨æˆ–æ•´ç‚¹å­˜å‚¨
2. **ä¼˜åŒ–ç¼“å­˜æ›´æ–°é€»è¾‘**ï¼šupdateäº‹ä»¶æ›´æ–°å†…å­˜ç¼“å­˜ï¼Œé€šè¿‡cronä»»åŠ¡å®šæ—¶åŒæ­¥åˆ°æ•°æ®åº“
3. **æé«˜ç³»ç»Ÿæ€§èƒ½**ï¼šå‡å°‘é«˜é¢‘æ•°æ®åº“I/Oï¼Œæå‡æ•´ä½“æ€§èƒ½

## ğŸ—ï¸ å®ç°æ–¹æ¡ˆ

### 1. ä¼˜åŒ–å­˜å‚¨æœºåˆ¶æ¶æ„

```go
// æ–°å¢ä¼˜åŒ–å­˜å‚¨ç»“æ„
optimizedStorage struct {
    mu                sync.RWMutex
    buffer            []models.EndpointSSE // ç¼“å†²åŒº
    maxBufferSize     int                  // æœ€å¤§ç¼“å†²å¤§å°ï¼ˆ1000ï¼‰
    lastFlushTime     time.Time            // ä¸Šæ¬¡åˆ·ç›˜æ—¶é—´
    hourlyFlushTicker *time.Ticker         // æ•´ç‚¹åˆ·ç›˜å®šæ—¶å™¨
}
```

### 2. åŒé‡è§¦å‘æœºåˆ¶

#### è§¦å‘æ–¹å¼1ï¼šæ‰¹é‡é˜ˆå€¼è§¦å‘
- **é˜ˆå€¼**: 1000ä¸ªäº‹ä»¶
- **è§¦å‘**: å½“ç¼“å†²åŒºè¾¾åˆ°1000ä¸ªäº‹ä»¶æ—¶è‡ªåŠ¨åˆ·ç›˜
- **ä¼˜åŠ¿**: ç¡®ä¿åœ¨é«˜æµé‡æƒ…å†µä¸‹åŠæ—¶å†™å…¥ï¼Œé¿å…å†…å­˜ç§¯å‹

#### è§¦å‘æ–¹å¼2ï¼šæ•´ç‚¹å®šæ—¶è§¦å‘  
- **æ—¶é—´**: æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œ
- **è§¦å‘**: æ— è®ºç¼“å†²åŒºå¤§å°ï¼Œæ•´ç‚¹å¿…å®šåˆ·ç›˜ä¸€æ¬¡
- **ä¼˜åŠ¿**: ç¡®ä¿åœ¨ä½æµé‡æƒ…å†µä¸‹æ•°æ®ä¹Ÿèƒ½åŠæ—¶æŒä¹…åŒ–

### 3. æ•°æ®æµç¨‹æ¶æ„

```mermaid
graph TD
    A[SSEæ¥æ”¶updateäº‹ä»¶] --> B[æ›´æ–°å†…å­˜ç¼“å­˜]
    B --> C[å‘é€åˆ°History Worker]
    A --> D[æ·»åŠ åˆ°ä¼˜åŒ–å­˜å‚¨ç¼“å†²åŒº]
    
    D --> E{è¾¾åˆ°1000ä¸ªäº‹ä»¶?}
    D --> F{æ•´ç‚¹æ—¶é—´åˆ°?}
    
    E -->|æ˜¯| G[æ‰¹é‡é˜ˆå€¼è§¦å‘åˆ·ç›˜]
    F -->|æ˜¯| H[æ•´ç‚¹å®šæ—¶è§¦å‘åˆ·ç›˜]
    
    G --> I[æ‰¹é‡å†™å…¥EndpointSSEè¡¨]
    H --> I
    
    C --> J[History Workerå¤„ç†]
    J --> K[ServiceHistoryè¡¨]
    
    B --> L[å†…å­˜ç¼“å­˜]
    L --> M[Cronä»»åŠ¡å®šæ—¶åŒæ­¥]
    M --> N[æ›´æ–°Tunnelè¡¨]
```

## ğŸ“ æ ¸å¿ƒä»£ç å®ç°

### 1. æ³¨é‡ŠåŸæœ‰å®æ—¶å­˜å‚¨é€»è¾‘

```go
// å¯¹äºupdateäº‹ä»¶ï¼Œä¼˜åŒ–å­˜å‚¨ç­–ç•¥
if event.EventType == models.SSEEventTypeUpdate {
    // ========================
    // æ³¨é‡Šæ‰åŸæ¥çš„å®æ—¶æ•°æ®åº“å†™å…¥é€»è¾‘ï¼ˆä¼˜åŒ–é¢‘ç‡ï¼‰
    // åŸé€»è¾‘ï¼šæ¯ä¸ªupdateäº‹ä»¶éƒ½ç«‹å³æ¨é€åˆ°storeJobChè¿›è¡Œæ•°æ®åº“å­˜å‚¨
    // ========================
    /*
    select {
    case s.storeJobCh <- event:
        // æˆåŠŸæŠ•é€’åˆ°å­˜å‚¨é˜Ÿåˆ—
    default:
        log.Warnf("[Master-%d]äº‹ä»¶å­˜å‚¨é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒäº‹ä»¶", endpointID)
    }
    */

    // æ–°çš„ä¼˜åŒ–ç­–ç•¥ï¼š
    // 1. ç´¯ç§¯åˆ°æ‰¹é‡é˜ˆå€¼æ—¶å†å­˜å‚¨ æˆ– æ•´ç‚¹å®šæ—¶å­˜å‚¨
    s.addToOptimizedStorage(event)
}
```

### 2. ä¼˜åŒ–å­˜å‚¨æ ¸å¿ƒæ–¹æ³•

```go
// addToOptimizedStorage æ·»åŠ äº‹ä»¶åˆ°ä¼˜åŒ–å­˜å‚¨ç¼“å†²åŒº
func (s *Service) addToOptimizedStorage(event models.EndpointSSE) {
    s.optimizedStorage.mu.Lock()
    defer s.optimizedStorage.mu.Unlock()

    // æ·»åŠ äº‹ä»¶åˆ°ç¼“å†²åŒº
    s.optimizedStorage.buffer = append(s.optimizedStorage.buffer, event)

    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ‰¹é‡é˜ˆå€¼
    if len(s.optimizedStorage.buffer) >= s.optimizedStorage.maxBufferSize {
        log.Infof("ä¼˜åŒ–å­˜å‚¨è¾¾åˆ°æ‰¹é‡é˜ˆå€¼ %dï¼Œè§¦å‘åˆ·ç›˜", s.optimizedStorage.maxBufferSize)
        
        // å¼‚æ­¥åˆ·ç›˜ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
        go s.flushOptimizedStorage("æ‰¹é‡é˜ˆå€¼")
    }
}
```

### 3. æ•´ç‚¹å®šæ—¶åˆ·ç›˜æœºåˆ¶

```go
// startHourlyFlushTimer å¯åŠ¨æ•´ç‚¹åˆ·ç›˜å®šæ—¶å™¨
func (s *Service) startHourlyFlushTimer() {
    // è®¡ç®—ä¸‹ä¸€ä¸ªæ•´ç‚¹æ—¶é—´
    now := time.Now()
    nextHour := now.Truncate(time.Hour).Add(time.Hour)
    
    // ç­‰å¾…åˆ°ä¸‹ä¸€ä¸ªæ•´ç‚¹ï¼Œç„¶åæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    time.AfterFunc(time.Until(nextHour), func() {
        s.optimizedStorage.hourlyFlushTicker = time.NewTicker(time.Hour)
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ•´ç‚¹åˆ·ç›˜
        s.flushOptimizedStorage("æ•´ç‚¹å®šæ—¶")
        
        // å¯åŠ¨å®šæ—¶åˆ·ç›˜å¾ªç¯
        go func() {
            for {
                select {
                case <-s.ctx.Done():
                    return
                case <-s.optimizedStorage.hourlyFlushTicker.C:
                    s.flushOptimizedStorage("æ•´ç‚¹å®šæ—¶")
                }
            }
        }()
    })
}
```

## ğŸ“Š æ€§èƒ½æå‡åˆ†æ

### åŸæ¥çš„å­˜å‚¨æ–¹å¼
```
æ¯ä¸ªupdateäº‹ä»¶ â†’ ç«‹å³æ•°æ®åº“å†™å…¥
é¢‘ç‡ï¼šæ¯5ç§’å¤šæ¬¡å†™å…¥ï¼ˆå–å†³äºå®ä¾‹æ•°é‡ï¼‰
æ•°æ®åº“å‹åŠ›ï¼šé«˜é¢‘å°é‡å†™å…¥
```

### ä¼˜åŒ–åçš„å­˜å‚¨æ–¹å¼
```
1000ä¸ªupdateäº‹ä»¶ â†’ æ‰¹é‡æ•°æ®åº“å†™å…¥ï¼ˆæˆ–æ•´ç‚¹å†™å…¥ï¼‰
é¢‘ç‡ï¼šæ‰¹é‡å†™å…¥æˆ–æ¯å°æ—¶å†™å…¥
æ•°æ®åº“å‹åŠ›ï¼šä½é¢‘å¤§é‡å†™å…¥
```

### æ€§èƒ½æå‡é¢„ä¼°
- **æ•°æ®åº“I/Oå‡å°‘**: çº¦å‡å°‘ 95% çš„å†™å…¥é¢‘ç‡
- **äº‹åŠ¡å¼€é”€å‡å°‘**: æ‰¹é‡å†™å…¥å‡å°‘äº‹åŠ¡æ•°é‡
- **é”ç«äº‰å‡å°‘**: é™ä½æ•°æ®åº“é”ç«äº‰
- **å†…å­˜ä½¿ç”¨**: è½»å¾®å¢åŠ ï¼ˆæœ€å¤§1000ä¸ªäº‹ä»¶ç¼“å†²ï¼‰

## ğŸ”„ ç¼“å­˜æ›´æ–°æœºåˆ¶

### å†…å­˜ç¼“å­˜å¤„ç†æµç¨‹

SSE updateäº‹ä»¶çš„å¤„ç†æµç¨‹ï¼š

1. **æ›´æ–°å†…å­˜ç¼“å­˜** (å·²æœ‰é€»è¾‘)
```go
// é¦–å…ˆæ›´æ–°å†…å­˜çŠ¶æ€
if err := s.memoryService.ProcessSSEEvent(endpointID, event); err != nil {
    // å¤„ç†é”™è¯¯...
}
```

2. **History Workerå¤„ç†** (æ–°å¢é€»è¾‘)
```go
// å°†updateäº‹ä»¶é€šè¿‡Dispatchæ–¹æ³•æ¨é€åˆ°History Worker
if s.historyWorker != nil {
    s.historyWorker.Dispatch(event)
}
```

3. **ä¼˜åŒ–å­˜å‚¨å¤„ç†** (æ–°å¢é€»è¾‘)
```go
// æ·»åŠ åˆ°ä¼˜åŒ–å­˜å‚¨ç¼“å†²åŒº
s.addToOptimizedStorage(event)
```

### å®šæ—¶åŒæ­¥æœºåˆ¶

å†…å­˜ç¼“å­˜ä¸­çš„éš§é“æ•°æ®é€šè¿‡ç°æœ‰çš„å®šæ—¶æœºåˆ¶åŒæ­¥åˆ°æ•°æ®åº“ï¼š

```go
// åœ¨å†…å­˜æœåŠ¡ä¸­å·²æœ‰çš„å®šæ—¶æŒä¹…åŒ–é€»è¾‘
func (s *Service) startPeriodicPersist() {
    ticker := time.NewTicker(5 * time.Second) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    // ... æ‰¹é‡æ›´æ–°éš§é“æµé‡æ•°æ®åˆ°æ•°æ®åº“
}
```

## ğŸ”§ é…ç½®å‚æ•°

### å¯è°ƒèŠ‚å‚æ•°

```go
const (
    MaxBufferSize = 1000        // æœ€å¤§ç¼“å†²åŒºå¤§å°
    BatchSize = 100             // æ•°æ®åº“æ‰¹é‡å†™å…¥å¤§å°  
    FlushInterval = time.Hour   // æ•´ç‚¹åˆ·ç›˜é—´éš”
)
```

### å‚æ•°è°ƒä¼˜å»ºè®®

| å‚æ•° | å»ºè®®å€¼ | åŸå›  |
|------|--------|------|
| **MaxBufferSize** | 1000 | å¹³è¡¡å†…å­˜ä½¿ç”¨å’Œå†™å…¥é¢‘ç‡ |
| **BatchSize** | 100 | é¿å…å•æ¬¡äº‹åŠ¡è¿‡å¤§ |
| **FlushInterval** | 1å°æ—¶ | ä¸ç°æœ‰cronä»»åŠ¡å¯¹é½ |

## ğŸ“ˆ ç›‘æ§å’Œç»Ÿè®¡

### æ–°å¢ç»Ÿè®¡ä¿¡æ¯

```go
"optimized_storage": {
    "buffer_size": 250,           // å½“å‰ç¼“å†²åŒºå¤§å°
    "max_buffer_size": 1000,      // æœ€å¤§ç¼“å†²åŒºå¤§å°
    "last_flush_time": "2024-01-20 15:00:00", // ä¸Šæ¬¡åˆ·ç›˜æ—¶é—´
    "buffer_usage_pct": 25.0      // ç¼“å†²åŒºä½¿ç”¨ç‡
}
```

### ç›‘æ§å…³é”®æŒ‡æ ‡

1. **ç¼“å†²åŒºä½¿ç”¨ç‡**: ç›‘æ§æ˜¯å¦æ¥è¿‘æœ€å¤§å€¼
2. **åˆ·ç›˜é¢‘ç‡**: æ‰¹é‡è§¦å‘ vs å®šæ—¶è§¦å‘çš„æ¯”ä¾‹
3. **åˆ·ç›˜è€—æ—¶**: ç›‘æ§æ•°æ®åº“å†™å…¥æ€§èƒ½
4. **æ•°æ®ä¸¢å¤±**: æœåŠ¡å¼‚å¸¸å…³é—­æ—¶çš„æ•°æ®ä¿æŠ¤

## ğŸ›¡ï¸ å®¹é”™å’Œæ¢å¤

### æœåŠ¡å…³é—­æ—¶çš„æ•°æ®ä¿æŠ¤

```go
// Closeæ–¹æ³•ä¸­çš„æ•°æ®ä¿æŠ¤
func (s *Service) Close() {
    // åœæ­¢æ•´ç‚¹åˆ·ç›˜å®šæ—¶å™¨
    if s.optimizedStorage.hourlyFlushTicker != nil {
        s.optimizedStorage.hourlyFlushTicker.Stop()
    }
    
    // åˆ·ç›˜å‰©ä½™çš„ç¼“å†²æ•°æ®
    s.flushOptimizedStorage("æœåŠ¡å…³é—­")
}
```

### å¼‚å¸¸å¤„ç†æœºåˆ¶

1. **ç¼“å†²åŒºæº¢å‡º**: è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨åˆ·ç›˜
2. **æ•°æ®åº“è¿æ¥å¼‚å¸¸**: é‡è¯•æœºåˆ¶å’Œé”™è¯¯æ—¥å¿—
3. **å†…å­˜ä¸è¶³**: ç›‘æ§ç¼“å†²åŒºä½¿ç”¨ç‡
4. **å®šæ—¶å™¨å¼‚å¸¸**: ä¸Šä¸‹æ–‡å–æ¶ˆæ—¶å®‰å…¨é€€å‡º

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. æ¸è¿›å¼éƒ¨ç½²

å»ºè®®æŒ‰ä»¥ä¸‹æ­¥éª¤éƒ¨ç½²ï¼š

1. **é˜¶æ®µ1**: å¯ç”¨ä¼˜åŒ–å­˜å‚¨ï¼Œä¿ç•™åŸæœ‰é€»è¾‘ä½œä¸ºå¤‡ä»½
2. **é˜¶æ®µ2**: è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œè°ƒä¼˜å‚æ•°
3. **é˜¶æ®µ3**: å®Œå…¨åˆ‡æ¢åˆ°ä¼˜åŒ–å­˜å‚¨æœºåˆ¶

### 2. ç›‘æ§è¦ç‚¹

- ç›‘æ§ `buffer_usage_pct` ä¸è¦é•¿æœŸè¶…è¿‡80%
- ç›‘æ§ `last_flush_time` ç¡®ä¿åŠæ—¶åˆ·ç›˜
- ç›‘æ§æ•°æ®åº“æ€§èƒ½å˜åŒ–
- ç›‘æ§å†…å­˜ä½¿ç”¨å˜åŒ–

### 3. å›æ»šé¢„æ¡ˆ

å¦‚å‡ºç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»šï¼š
```go
// æ¢å¤åŸæœ‰é€»è¾‘ï¼ˆå–æ¶ˆæ³¨é‡Šï¼‰
select {
case s.storeJobCh <- event:
    // æˆåŠŸæŠ•é€’åˆ°å­˜å‚¨é˜Ÿåˆ—
default:
    log.Warnf("[Master-%d]äº‹ä»¶å­˜å‚¨é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒäº‹ä»¶", endpointID)
}
```

## âœ… å®ç°éªŒè¯

### åŠŸèƒ½éªŒè¯æ¸…å•

- âœ… **æ‰¹é‡é˜ˆå€¼è§¦å‘**: 1000ä¸ªäº‹ä»¶è‡ªåŠ¨åˆ·ç›˜
- âœ… **æ•´ç‚¹å®šæ—¶è§¦å‘**: æ¯å°æ—¶æ•´ç‚¹è‡ªåŠ¨åˆ·ç›˜  
- âœ… **æœåŠ¡å…³é—­ä¿æŠ¤**: å…³é—­æ—¶åˆ·ç›˜å‰©ä½™æ•°æ®
- âœ… **å¹¶å‘å®‰å…¨**: è¯»å†™é”ä¿æŠ¤ç¼“å†²åŒº
- âœ… **ç»Ÿè®¡ç›‘æ§**: å®Œæ•´çš„è¿è¡ŒçŠ¶æ€ç»Ÿè®¡
- âœ… **é”™è¯¯å¤„ç†**: æ•°æ®åº“å¼‚å¸¸æ—¶çš„é‡è¯•å’Œæ—¥å¿—
- âœ… **èµ„æºæ¸…ç†**: å®šæ—¶å™¨å’Œå†…å­˜èµ„æºçš„æ­£ç¡®æ¸…ç†

### æ€§èƒ½æµ‹è¯•å»ºè®®

1. **é«˜å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¤šå®ä¾‹åŒæ—¶å‘é€updateäº‹ä»¶
2. **é•¿æ—¶é—´è¿è¡Œæµ‹è¯•**: éªŒè¯å†…å­˜ä¸æ³„æ¼ï¼Œå®šæ—¶æœºåˆ¶æ­£å¸¸
3. **å¼‚å¸¸æ¢å¤æµ‹è¯•**: æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ä¸­æ–­ç­‰å¼‚å¸¸æƒ…å†µ
4. **æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**: éªŒè¯æ‰¹é‡å†™å…¥çš„æ•°æ®å®Œæ•´æ€§

## ğŸ‰ æ€»ç»“

æ­¤æ¬¡ä¼˜åŒ–å®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. âœ… **å¤§å¹…å‡å°‘æ•°æ®åº“å†™å…¥é¢‘ç‡**: ä»æ¯5ç§’å¤šæ¬¡å†™å…¥ä¼˜åŒ–ä¸ºæ‰¹é‡/å®šæ—¶å†™å…¥
2. âœ… **ä¿æŒæ•°æ®å®Œæ•´æ€§**: åŒé‡è§¦å‘æœºåˆ¶ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
3. âœ… **æå‡ç³»ç»Ÿæ€§èƒ½**: å‡å°‘æ•°æ®åº“I/Oå‹åŠ›å’Œé”ç«äº‰
4. âœ… **å®Œå–„ç›‘æ§ç»Ÿè®¡**: æä¾›è¯¦ç»†çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯
5. âœ… **ä¿è¯ç³»ç»Ÿç¨³å®šæ€§**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†æœºåˆ¶

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆåœ¨ä¿è¯æ•°æ®å®‰å…¨çš„å‰æä¸‹ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿæ€§èƒ½ï¼Œä¸ºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç¨³å®šè¿è¡Œå¥ å®šäº†åŸºç¡€ï¼
